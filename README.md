# Project Overview
 Automated (or semi-automated) Arch Linux system upgrade followed by security auditing, with clear separation of concerns, reliable hand-off points, and future offline AI summarization support.
 It should be a multi-user system tool

# Motivations
- learn systemd and daemons better
- automate security checks and upgrade

# Structure
`~/scripts/system-security-upgrader/` development dir
	`README.md` docs
	`upgrade.sh` update mirrorlist with reflector, upgrade system & reboot
	`security-check.sh` check system security, summarize with ai
	`ai-summarizer.sh` summarize logs with ai and save to md file
	`install.sh` installation script
`/var/log/system-security-upgrader/` log files
`/usr/local/sbin/upgrade` deployment of `~/scripts/system-security-upgrader/upgrade.sh` 
`/usr/local/sbin/security-check` deployment of `~/scripts/system-security-upgrader/security-check.sh`
`/usr/local/bin/security_upgrader_ai-summarizer` deployment of `~/scripts/system-security-upgrader/ai-summarizer.sh`

# Dependencies
- Arch-system 
- reflector # for updating the mirrorlists
- lynis # for security checking 
- ollama + local ai model # for ai summary
- bash # script interpreter
- arch-audit # for arch audit
- ufw # for checking the status of the firewall
- systemd # for daemons and reboot
- rkhunter # for rootkit checking
- notifications with notify-send # for user interaction (such as asking the user if the computer should reboot)
- curl # for checking if the internet is working (optional)


# Phase 1: Upgrade & Reboot
This script is there to perform system upgrades and reboot the system after they are done. 
This script is ran by the root user, but the regular user have to be in the config.json file (done with install.sh)

Note: The dirname YYYY-mm-dd_HH-MM-SS is named by the time the script STARTED.
Inside the logfile, the timestamps are just after it actually happened.


The logs of the tools (reflector, pacman, systemd) are written in their own logfiles
(`/var/log/system-security-upgrader/YYYY-mm-dd_HH-MM-SS_upgrade/tool.log` )


Deployment path:
`/usr/local/sbin/upgrade`

What it does:
1. Check if root is running it
2. Save the `$SUDO_USER` for later
3. Check if the internet works
4. run reflector to get the latest mirrorlists and perform the upgrade faster
5. upgrade the system
6. if the upgrade finished without errors, ask user via read  to reboot now and then reboot, if not, the script exits with exit code 0 and on the next reboot the security checks will be performed.

# Phase 2: security check
This script is there to run security tools, write security logs which will be analyzed later by local ai.
It will be executed by the root user because the security tools need root privileges.

Note: The dirname YYYY-mm-dd_HH-MM-SS is named by the time the script STARTED.
Inside the logfile, the timestamps are just after it actually happened.


The logs of the tools (lynis, rkhunter, arch-audit, systemd, ...) are written in their own logfiles
(`/var/log/system-security-upgrader/YYYY-mm-dd_HH-MM-SS_security-check/tool.log` )
Deployment path:
`/usr/local/sbin/security-check`

Daemon path:
`/etc/systemd/system/security-upgrader.service`


What it does:
1. Run security tools (lynis, rkhunter, archaudit) and write the stdout and stderr into a logfile for each tool
2. trigger the next script by creating a trigger file with the path to the log dir as content.


# Phase 3: ai summary
This script summarizes the logs from the tools created in phase 3 using local ai with ollama, and produces `summary.md` in the log dir of the 2nd phase. The logs of ollama and the tools used in this script will maybe be shared with the ones of the 2nd phase.

Note: The dirname YYYY-mm-dd_HH-MM-SS is named by the time the script STARTED.
Note: The `user` in the ai summary save path is the user saved earlier from upgrade.sh (phase1) in step 2

Inside the logfile, the timestamps are just after it actually happened.
Deployment path:
`/usr/local/bin/security_upgrader_ai-summarizer`

Daemon path:
`/etc/systemd/system/`

Condition path containing the username (captured in phase 1) and log dir of phase2:
`/var/lib/system-security-upgrader/pending-ai-summary`

Where the ai summary is stored:
`/var/lib/system-security-upgrader/summaries/<username>/YYYY-mm-dd_HH-MM-SS_ai-summary.md`

Owner of the `summary.md` generated by the local ai:
the user, NOT ROOT

The ai summary is for convenience and for being delivered to the user, it is more comfortable to read than the logs (e.g. in an email)

What it does:
1. Take the logs from the 2nd phase
2. Filter them down to warings, uniq content and summaries
3. Feed the filtered content to local ai with a custom system prompt and summarize it
4. Write the ai output to the file


# Installation
## quick installation
1. `cd` into the project dir
2. run  the following:
```bash
chmod +x install.sh
sudo ./install.sh
```

## manual installation
1. Copy scripts to /usr/local/sbin/ 
2. Set owner as root and permissions to 755 to the scripts 
3. Copy `security-upgrader.service` to  `/etc/systemd/system/security-upgrader.service` to set up the daemon
4. Reload the daemons with `sudo systemctl daemon-reload`
```bash
# cd into the project dir
# copy scripts
sudo cp upgrade.sh /usr/local/sbin/upgrade
sudo cp security-check.sh /usr/local/sbin/security-check

# set permissions
sudo chmod +x /usr/local/sbin/upgrade
sudo chmod +x /usr/local/sbin/security-check
# change owner to root for the scripts
sudo chown root:root /usr/local/sbin/upgrade
sudo chown root:root /usr/local/sbin/security-check

# set up daemon
sudo cp security-upgrader.service /etc/systemd/system/security-upgrader.service

# reload daemons
sudo systemctl daemon-reload 
```
# Usage
```bash
sudo upgrade
```
This will execute the upgrade script which will cause the reboot. After the reboot, the second script is executed automatically.

How to inspect logs:
```bash
cat /var/log/system-security-upgrader/YYYY-mm-dd_HH-MM-SS_upgrade/* # logs from the upgrade script
cat /var/log/system.security-upgrader/YYYY-mm-dd_HH-MM-SS_security-check/* # logs from the security check script
journalctl -u security-upgrader.service
```

# Logging
Main Logfile: `/var/log/system-security-upgrader/YYYY-mm-dd_HH-MM-SS_script/script.log`
Note: The dirname YYYY-mm-dd_HH-MM-SS is named by the time the script STARTED.
Inside the logfile, the timestamps are just after it actually happened.
Inside logfile structure:
`YYYY-mm-dd_HH-MM-SS - LOGLEVEL: message` 

The logs of the tools (reflector, pacman, systemd, ...) are written in their own logfiles
(`/var/log/system-security-upgrader/YYYY-mm-dd_HH-MM-SS/tool.log` )

# Troubleshooting
## Common errors:
- Permission denied: use sudo for upgrade script and check the file permissions that should be 755.
- Command not found: check `$PATH` and shebang in the scripts
- AI summary fails: check model availability, test the model manually

## Test without reboot:
1. Run upgrade script (`upgrade`)
2. When the read prompt appears, type `n`.
3. Run `sudo security-check` in the terminal to perform the security checks.

# Future improvements
- email notifications
- dry-run mode
- add non-interactive mode
- remove orphanage packages
- check ufw status
- add systemctl --failed to security-check.sh
- add analyze journalctl/system logs to ai input to not only spot security vulnerabilities but also find errors
- check if the internet connection works
- let the security script create a pkglist
- add notify-send to ask for reboot and other things, read prompt only as alternative
- send message to user (telegram or email) with the ai summary
- only make ONE logdir for both upgrade and security checks
- add json config
# Author Info
- username: daemonnd
- email: find at github profile

# MIT License

Copyright (c) 2012-2024 Scott Chacon and others

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. 

Here is a concise, README-ready summary of the **system-security-upgrader** project architecture, focused only on the most relevant structural and operational aspects (in bullet-point form):



# TODO
- add `architecture/` dir with full architecture docs